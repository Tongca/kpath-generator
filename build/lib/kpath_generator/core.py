import os
import sys
from ase.io import read
import seekpath

__author__ = "Tongcai Yue"
__maintainer__ = "Tongcai Yue"
__email__ = "Tongcai_yue@buaa.edu.cn"


def display_label(label):
    """Convert internal label to display label"""
    return "Î“" if label == "G" else label


def read_poscar(poscar="POSCAR"):
    """
    Read POSCAR and return cell tuple required by SeeK-path:
    (cell, scaled_positions, atomic_numbers)
    """
    atoms = read(poscar)
    cell = atoms.cell.array
    positions = atoms.get_scaled_positions()
    numbers = atoms.get_atomic_numbers()
    return (cell, positions, numbers)


def get_seekpath(poscar="POSCAR"):
    """
    Generate standard high-symmetry path using SeeK-path (HPKOT)
    """
    cell = read_poscar(poscar)
    return seekpath.get_path(
        cell,
        with_time_reversal=True,
        symprec=1e-5,
        recipe="hpkot"
    )


def write_band_conf(result, npoints=50):
    """
    Write phonopy band.conf
    """
    labels = []

    with open("band.conf", "w", encoding="utf-8") as f:
        f.write("# Generated by run_band.py using SeeK-path (HPKOT)\n")
        f.write("# Fractional coordinates in reciprocal primitive cell\n\n")

        f.write("BAND = \\\n")
        for start, end in result["path"]:
            k1 = result["point_coords"][start]
            k2 = result["point_coords"][end]

            f.write(
                f"  {k1[0]:.6f} {k1[1]:.6f} {k1[2]:.6f} "
                f"{k2[0]:.6f} {k2[1]:.6f} {k2[2]:.6f}\n"
            )

            if not labels or labels[-1] != start:
                labels.append(start)
            labels.append(end)

        f.write("\n")
        f.write(f"BAND_POINTS = {npoints}\n")
        f.write(
            "BAND_LABELS = " +
            " ".join(display_label(l) for l in labels) +
            "\n"
        )

    return labels


def write_shengbte_kpath(result):
    """
    Reference high-symmetry path (NOT used for transport)
    """
    with open("KPATH_ShengBTE", "w", encoding="utf-8") as f:
        f.write("# High-symmetry path (reference only)\n")
        f.write("# Generated using SeeK-path (HPKOT)\n\n")

        for start, end in result["path"]:
            k1 = result["point_coords"][start]
            k2 = result["point_coords"][end]
            f.write(
                f"{k1[0]:.6f} {k1[1]:.6f} {k1[2]:.6f}\n"
                f"{k2[0]:.6f} {k2[1]:.6f} {k2[2]:.6f}\n\n"
            )


def write_alamode_kpath(result, npoints=50):
    """
    Write ALAMODE KPATH file
    """
    with open("KPATH_ALAMODE", "w", encoding="utf-8") as f:
        f.write("# Generated by run_band.py using SeeK-path (HPKOT)\n")
        f.write("# Fractional coordinates in reciprocal primitive cell\n\n")

        for start, end in result["path"]:
            k1 = result["point_coords"][start]
            k2 = result["point_coords"][end]
            f.write(
                f"{start:>3s} {k1[0]:.6f} {k1[1]:.6f} {k1[2]:.6f}   "
                f"{end:>3s} {k2[0]:.6f} {k2[1]:.6f} {k2[2]:.6f}   "
                f"{npoints}   ! {display_label(start)}-{display_label(end)}\n"
            )


def write_qe_bands_kpoints(result, npoints=50):
    """
    Write Quantum ESPRESSO K_POINTS for bands.x (crystal_b)
    - Avoid duplicated consecutive high-symmetry points
    - Last k-point weight is set to 1
    """
    path = result["path"]
    coords = result["point_coords"]

    kseq = []
    for start, end in path:
        if not kseq or kseq[-1] != start:
            kseq.append(start)
        if kseq[-1] != end:
            kseq.append(end)

    with open("KPOINTS_QE_BANDS", "w", encoding="utf-8") as f:
        f.write("K_POINTS crystal_b\n")
        f.write(f"{len(kseq)}\n")

        for i, lab in enumerate(kseq):
            k = coords[lab]
            nk = npoints if i < len(kseq) - 1 else 1
            f.write(
                f"{k[0]:.6f} {k[1]:.6f} {k[2]:.6f}  "
                f"{nk:4d}  ! {display_label(lab)}\n"
            )


def main():
    if not os.path.exists("POSCAR"):
        print("ERROR: POSCAR not found")
        sys.exit(1)

    result = get_seekpath("POSCAR")

    print("=== Crystal info ===")
    print("Bravais lattice :", result["bravais_lattice"])
    print("Space group     :", result["spacegroup_international"])
    print("SG number       :", result["spacegroup_number"])
    print("====================")

    write_band_conf(result)
    write_shengbte_kpath(result)
    write_alamode_kpath(result)
    write_qe_bands_kpoints(result)

    print("Generated files:")
    print("  band.conf           (phonopy)")
    print("  KPATH_ALAMODE       (ALAMODE)")
    print("  KPATH_ShengBTE      (reference)")
    print("  KPOINTS_QE_BANDS    (Quantum ESPRESSO bands.x)")
    print()
    print('Methods sentence:')
    print('  "High-symmetry paths were generated using SeeK-path (HPKOT)."')
